# Data Format Documentation

This document describes the data formats supported by ChirpStack Provisioning for setting up ChirpStack infrastructure and importing devices.

## Overview

ChirpStack Provisioning uses a **two-file approach** for provisioning:

1. **Setup File** (`setup.schema.json`): Defines infrastructure including tenants, device profiles, applications, integrations, and gateways
   - Format: JSON only (YAML and TOML support planned for future)
   - Hierarchical structure with nested entities
   - Processed first to establish the infrastructure

2. **Device File** (`devices.schema.json`): Defines individual devices to be provisioned
   - Formats: JSON, JSONL, or CSV
   - Flat structure where each object/line represents a single device
   - Processed after the setup file as it references applications and device profiles created in the setup phase
   - Identified by Device EUI (Extended Unique Identifier)

## Special Field Markers

The schemas use special field markers to indicate automatic field handling:

- **`*field_name`** (single asterisk): Fields marked with `*` have the value `"AUTO-GENERATED"`. These are IDs (UUIDs) that will be automatically generated by ChirpStack when the entity is created.

- **`**field_name`** (double asterisk): Fields marked with `**` have values like `"AUTO-FILL"` or `"AUTO-PARENT"`:
  - `"AUTO-FILL"`: The value will be automatically looked up from existing ChirpStack entities (e.g., looking up an application ID from its name)
  - `"AUTO-PARENT"`: The value will be automatically filled from the parent entity in the hierarchical structure

- **`_entity_name`** (underscore prefix): Fields starting with `_` indicate nested/related entities or integrations that have special handling.

## Setup File Structure

### Tenants

Tenants are the top-level organizational unit in ChirpStack.

### Tenants

Tenants are the top-level organizational unit in ChirpStack.

**Required Fields:**
- `name`: Tenant name (1-100 characters)

**Optional Fields:**
- `*id`: Auto-generated tenant UUID (marker field, use `"AUTO-GENERATED"`)
- `description`: Tenant description (max 500 characters)
- `can_have_gateways`: Boolean, whether tenant can own gateways (default: true)
- `max_gateway_count`: Maximum number of gateways (0 = unlimited, default: 0)
- `max_device_count`: Maximum number of devices (0 = unlimited, default: 0)
- `private_gateways_up`: Boolean, private uplink gateways (default: false)
- `private_gateways_down`: Boolean, private downlink gateways (default: false)
- `tags`: Object with tenant tags (not exposed in integration events)
- `gateways`: Array of gateway objects belonging to this tenant
- `applications`: Array of application objects belonging to this tenant
- `_deviceProfiles`: Array of device profile objects belonging to this tenant

### Gateways

Gateways are infrastructure components that receive LoRaWAN transmissions. In the setup file, gateways are nested under tenants.

**Required Fields:**
- `gateway_id`: Gateway ID in hexadecimal format (16 characters, EUI64)
- `name`: Gateway name (1-100 characters)

**Optional Fields:**
- `*tenant_id`: Auto-filled from parent tenant (marker field, use `"AUTO-PARENT"`)
- `description`: Gateway description (max 500 characters)
- `tags`: Object with gateway tags
- `metadata`: Object with gateway metadata
- `stats_interval`: Statistics reporting interval in seconds (1-86400, default: 30)
- `location`: Location object with the following fields:
  - `latitude`: Latitude coordinate (-90 to 90)
  - `longitude`: Longitude coordinate (-180 to 180)
  - `altitude`: Altitude in meters
  - `source`: Location source (e.g., "GPS", "CONFIG")
  - `accuracy`: Location accuracy in meters

### Applications

Applications group related devices together. In the setup file, applications are nested under tenants.

**Required Fields:**
- `name`: Application name (1-100 characters)

**Optional Fields:**
- `*id`: Auto-generated application UUID (marker field, use `"AUTO-GENERATED"`)
- `*tenant_id`: Auto-filled from parent tenant (marker field, use `"AUTO-PARENT"`)
- `description`: Application description (max 500 characters)
- `tags`: Object with application tags (exposed in all device integration events)
- `_InfluxDbIntegration`: InfluxDB integration configuration (see below)

### InfluxDB Integration

InfluxDB integration can be configured for applications to automatically forward device data.

**Required Fields:**
- `version`: InfluxDB version (0 = v1, 1 = v2)

**Optional Fields:**
- `*application_id`: Auto-filled from parent application (marker field, use `"AUTO-PARENT"`)
- `endpoint` or `endpoint_env_var`: InfluxDB endpoint URL
- For InfluxDB v1:
  - `db`: Database name
  - `username`: Username
  - `password`: Password
  - `retention_policy_name`: Retention policy
- For InfluxDB v2:
  - `token` or `token_env_var`: Authentication token
  - `organization` or `organization_env_var`: Organization name
  - `bucket` or `bucket_env_var`: Bucket name
- `precision`: Time precision (NS, U, MS, S, M, H; default: NS)

### Device Profiles

Device profiles define the LoRaWAN configuration for devices. In the setup file, device profiles are nested under tenants.

**Required Fields:**
- `name`: Device profile name (1-100 characters)
- `region`: LoRaWAN region (e.g., "AU915", "US915", "EU868")
- `mac_version`: MAC version (e.g., "LORAWAN_1_0_4")
- `reg_params_revision`: Regional parameters revision (e.g., "RP002_1_0_1")
- `supports_otaa`: Boolean, supports OTAA activation

**Optional Fields:**
- `*id`: Auto-generated device profile UUID (marker field, use `"AUTO-GENERATED"`)
- `*tenant_id`: Auto-filled from parent tenant (marker field, use `"AUTO-PARENT"`)
- `description`: Device profile description (max 500 characters)
- `supports_class_b`: Boolean, supports Class B (default: false)
- `supports_class_c`: Boolean, supports Class C (default: false)
- `adr_algorithm_id`: ADR algorithm ID (default: "default")
- `payload_codec_runtime`: Codec runtime ("NONE", "CAYENNE_LPP", "JS"; default: "NONE")
- `payload_codec_script`: JavaScript codec script
- `payload_codec_script_path`: Path to codec script file
- `uplink_interval`: Expected uplink interval in seconds (0 = no expectation)
- `device_status_req_interval`: Device status requests per day
- `tags`: Object with device profile tags
- `auto_detect_measurements`: Boolean, auto-detect measurements (default: true)

## Device File Structure

### Devices

Devices are LoRaWAN end-devices that send data through the network. The device file uses a flat structure.

**Required Fields:**
- `name`: Device name (1-100 characters)
- `dev_eui`: Device EUI in hexadecimal format (16 characters, EUI64)
- `application_name`: Application name to link device to (must exist)
- `device_profile_name`: Device profile name to use (must exist)

**Optional Fields:**
- `**application_id`: Auto-filled by looking up application_name (marker field, use `"AUTO-FILL"`)
- `**device_profile_id`: Auto-filled by looking up device_profile_name (marker field, use `"AUTO-FILL"`)
- `description`: Device description (max 500 characters)
- `skipFCntCheck`: Boolean, skip frame counter checks (default: false, insecure)
- `is_disabled`: Boolean, device is disabled (default: false)
- `variables`: Object with device variables (not exposed in events)
- `tags`: Object with device tags (exposed in all integration events)
- `join_eui`: JoinEUI in hexadecimal (16 characters, optional for OTAA)
- `_deviceKeys`: Device keys object for OTAA activation:
  - `**dev_eui`: Auto-filled from parent device (marker field, use `"AUTO-PARENT"`)
  - `nwk_key`: Network key in hexadecimal (32 characters, required)
  - `app_key`: Application key in hexadecimal (32 characters, for LoRaWAN 1.1+)

## Data Format Examples

### Setup File (JSON)

The setup file defines the ChirpStack infrastructure in a hierarchical structure:

```json
{
  "tenants": [
    {
      "name": "smart-city",
      "*id": "AUTO-GENERATED",
      "description": "Smart City IoT Infrastructure",
      "can_have_gateways": true,
      "max_gateway_count": 50,
      "max_device_count": 1000,
      "tags": {
        "environment": "production"
      },
      "gateways": [
        {
          "gateway_id": "0000000000001234",
          "name": "Downtown Gateway",
          "*tenant_id": "AUTO-PARENT",
          "stats_interval": 30,
          "location": {
            "latitude": 52.520008,
            "longitude": 13.404954,
            "altitude": 25.5
          }
        }
      ],
      "applications": [
        {
          "name": "environmental-monitoring",
          "*id": "AUTO-GENERATED",
          "*tenant_id": "AUTO-PARENT",
          "description": "Environmental sensors",
          "_InfluxDbIntegration": {
            "*application_id": "AUTO-PARENT",
            "version": 1,
            "bucket_env_var": "IDB_BUCKET",
            "organization_env_var": "IDB_ORG",
            "token_env_var": "IDB_TOKEN",
            "endpoint_env_var": "IDB_ENDPOINT"
          }
        }
      ],
      "_deviceProfiles": [
        {
          "name": "class-a-sensor",
          "*id": "AUTO-GENERATED",
          "*tenant_id": "AUTO-PARENT",
          "region": "AU915",
          "mac_version": "LORAWAN_1_0_4",
          "reg_params_revision": "RP002_1_0_1",
          "supports_otaa": true,
          "supports_class_b": false,
          "supports_class_c": false,
          "payload_codec_runtime": "JS",
          "payload_codec_script_path": "codecs/sensor.js"
        }
      ]
    }
  ]
}
```

### Device File Formats

#### JSON Format

Array of device objects:

```json
[
  {
    "name": "Temperature Sensor 01",
    "dev_eui": "0123456789ABCDEF",
    "description": "Outdoor temperature sensor",
    "**application_id": "AUTO-FILL",
    "**device_profile_id": "AUTO-FILL",
    "application_name": "environmental-monitoring",
    "device_profile_name": "class-a-sensor",
    "skipFCntCheck": false,
    "is_disabled": false,
    "tags": {
      "location": "parking-lot",
      "sensor_type": "temperature"
    },
    "_deviceKeys": {
      "**dev_eui": "AUTO-PARENT",
      "nwk_key": "0123456789ABCDEF0123456789ABCDEF"
    }
  },
  {
    "name": "Motion Sensor 01",
    "dev_eui": "FEDCBA9876543210",
    "description": "PIR motion sensor",
    "**application_id": "AUTO-FILL",
    "**device_profile_id": "AUTO-FILL",
    "application_name": "security-monitoring",
    "device_profile_name": "class-a-sensor",
    "skipFCntCheck": false,
    "is_disabled": false,
    "_deviceKeys": {
      "**dev_eui": "AUTO-PARENT",
      "nwk_key": "FEDCBA9876543210FEDCBA9876543210"
    }
  }
]
```

#### JSONL Format

Each line contains a complete device JSON object:

```jsonl
{"name": "Temperature Sensor 01", "dev_eui": "0123456789ABCDEF", "**application_id": "AUTO-FILL", "**device_profile_id": "AUTO-FILL", "application_name": "environmental-monitoring", "device_profile_name": "class-a-sensor", "_deviceKeys": {"**dev_eui": "AUTO-PARENT", "nwk_key": "0123456789ABCDEF0123456789ABCDEF"}}
{"name": "Motion Sensor 01", "dev_eui": "FEDCBA9876543210", "**application_id": "AUTO-FILL", "**device_profile_id": "AUTO-FILL", "application_name": "security-monitoring", "device_profile_name": "class-a-sensor", "_deviceKeys": {"**dev_eui": "AUTO-PARENT", "nwk_key": "FEDCBA9876543210FEDCBA9876543210"}}
```

#### CSV Format

CSV files must include a header row with column names matching the JSON field names. Complex nested objects (like `_deviceKeys`) should be flattened in CSV.

**Device CSV Example:**
```csv
name,dev_eui,description,application_name,device_profile_name,skipFCntCheck,is_disabled,nwk_key
Temperature Sensor 01,0123456789ABCDEF,Outdoor temperature sensor,environmental-monitoring,class-a-sensor,false,false,0123456789ABCDEF0123456789ABCDEF
Motion Sensor 01,FEDCBA9876543210,PIR motion sensor,security-monitoring,class-a-sensor,false,false,FEDCBA9876543210FEDCBA9876543210
Humidity Sensor 01,1122334455667788,Indoor humidity sensor,environmental-monitoring,class-a-sensor,false,false,11223344556677881122334455667788
```

**CSV Notes:**
- Complex objects like `tags`, `variables`, and `_deviceKeys` are simplified in CSV format
- The `nwk_key` column represents the `_deviceKeys.nwk_key` field
- Empty cells are treated as null/undefined values
- Boolean values should be "true" or "false" (case insensitive)

## Validation Rules

### Format Validation

**Setup File:**
- **Names**: 1-100 characters, no leading/trailing whitespace
- **Descriptions**: Maximum 500 characters
- **EUI Fields** (Gateway IDs): Must be exactly 16 hexadecimal characters (0-9, A-F, case insensitive)
- **Coordinates**: Latitude (-90 to 90), Longitude (-180 to 180)
- **Stats Interval**: Integer between 1 and 86400 seconds
- **Region**: Must be a valid LoRaWAN region code
- **MAC Version**: Must be a valid LoRaWAN MAC version

**Device File:**
- **EUI Fields** (Device EUI, Join EUI): Must be exactly 16 hexadecimal characters (0-9, A-F, case insensitive)
- **Keys** (nwk_key, app_key): Must be exactly 32 hexadecimal characters
- **Names**: 1-100 characters, no leading/trailing whitespace
- **Descriptions**: Maximum 500 characters

### Business Logic Validation

**Setup File:**
- **Unique Gateway IDs**: Gateway IDs must be unique within the setup file
- **Valid Hierarchical Structure**: Gateways, applications, and device profiles must be properly nested under tenants
- **Integration Configuration**: InfluxDB integration must have either direct values or environment variables for required fields

**Device File:**
- **Application Existence**: The specified `application_name` must exist in ChirpStack (created via setup file or already existing)
- **Device Profile Existence**: The specified `device_profile_name` must exist in ChirpStack (created via setup file or already existing)
- **Unique Device EUIs**: Device EUIs must be unique within the dataset
- **Device Keys**: If `_deviceKeys` is provided, `nwk_key` is required

### Processing Order

1. **Setup File First**: The setup file must be processed before the device file
   - Creates tenants, device profiles, applications, gateways, and integrations
   - Establishes the infrastructure that devices will reference

2. **Device File Second**: The device file is processed after the setup file
   - References applications and device profiles by name
   - These entities must already exist in ChirpStack (either from the setup file or pre-existing)

### CSV-Specific Notes
- Empty cells are treated as null/undefined values
- Boolean values should be represented as "true" or "false" (case insensitive)
- Complex objects (tags, variables, _deviceKeys) are simplified or flattened in CSV
- The `nwk_key` column maps to `_deviceKeys.nwk_key` in the JSON structure

## Error Handling

When validation fails, the system will provide specific error messages indicating:
- Which field is invalid
- What the expected format is
- Whether referenced entities (applications, device profiles) exist
- Line/row numbers for easier debugging
- For setup files: validation errors in the hierarchical structure

## Two-File Workflow

The typical workflow for provisioning a ChirpStack server is:

1. **Create Setup File** (`setup.json`):
   - Define tenant(s) with infrastructure
   - Include gateways under tenants
   - Include applications under tenants
   - Include device profiles under tenants
   - Configure integrations for applications

2. **Process Setup File**:
   - Validate against `setup.schema.json`
   - Create/update all infrastructure entities in ChirpStack
   - Note the generated IDs for reference

3. **Create Device File** (`devices.json`, `devices.jsonl`, or `devices.csv`):
   - Define individual devices
   - Reference applications and device profiles by name
   - Include device keys for OTAA

4. **Process Device File**:
   - Validate against `devices.schema.json`
   - Look up application and device profile IDs by name
   - Create/update devices in ChirpStack

## Assumptions

The current implementation assumes:
- **Setup-Then-Devices Workflow**: Setup file must be processed before device file
- **Name-Based Lookups**: Devices reference applications and device profiles by name, not UUID
- **Single File per Type**: One setup file and one device file per provisioning operation
- **Existing ChirpStack Server**: A running ChirpStack v4 server with API access is available